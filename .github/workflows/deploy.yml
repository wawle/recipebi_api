name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to Test or Prod
        env:
          BRANCH: ${{ github.ref_name }}
          SERVER: ${{ secrets.SERVER }}
          USER: ${{ secrets.USER }}
        run: |
          if [ "$BRANCH" == "main" ]; then
             ssh $USER@$SERVER "
               cd /var/www/recipebi_api && \
               git pull origin main && \
               
               # Clean up and redeploy
               docker compose down --volumes --remove-orphans && \
               docker compose up --build -d
             "
           fi
